let restaurant;
var newMap;
/**
 * Initialize map as soon as the page is loaded.
 */

document.addEventListener('DOMContentLoaded', event => {
  initMap();
  registerServiceWorker();
});
/**
 * Initialize worker
 */

const worker = new Worker('js/worker.js');
worker.addEventListener('message', e => {
  switch (e.data.cmd) {
    case 'fetch_reviews':
      if (e.data.error) {
        console.log(e.data.error);
        return;
      }

      generateReviewsHTML(e.data.reviews);
      break;

    case 'fetch_restaurant':
      if (e.data.error) {
        console.log(e.data.error);
        return;
      }

      self.restaurant = e.data.restaurant;
      fillRestaurantHTML();
      handleRestaurant(null, self.restaurant);
      break;
  }
});
/**
 * Initialize leaflet map
 */

initMap = () => {
  fetchRestaurantFromURL();
};
/**
 * Get current restaurant from page URL.
 */


fetchRestaurantFromURL = () => {
  if (self.restaurant) {
    // restaurant already fetched!
    handleRestaurant(null, self.restaurant);
    return;
  }

  const id = getParameterByName('id');

  if (!id) {
    // no id found in URL
    error = 'No restaurant id in URL';
    handleRestaurant(error, null);
  } else {
    worker.postMessage({
      cmd: 'fetch_restaurant',
      id: id
    });
  }
};
/**
 * Handle restaurant callback
 */


handleRestaurant = (error, restaurant) => {
  if (error) {
    // Got an error!
    console.error(error);
  } else {
    self.newMap = L.map('map', {
      center: [restaurant.latlng.lat, restaurant.latlng.lng],
      zoom: 16,
      scrollWheelZoom: false
    });
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.jpg70?access_token={mapboxToken}', {
      mapboxToken: 'pk.eyJ1IjoibGVtYSIsImEiOiJjamt0YXVla2MwM3NjM3dvZHQ0NDIwZmVpIn0.pOEFaPY6enCchIG29Lo2SQ',
      maxZoom: 18,
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' + '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' + 'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
      id: 'mapbox.streets'
    }).addTo(newMap);
    fillBreadcrumb();
    DBHelper.mapMarkerForRestaurant(self.restaurant, self.newMap);
  }
};
/**
 * Create restaurant HTML and add it to the webpage
 */


fillRestaurantHTML = (restaurant = self.restaurant) => {
  const name = document.getElementById('restaurant-name');
  name.innerHTML = restaurant.name;
  const address = document.getElementById('restaurant-address');
  address.innerHTML = restaurant.address;
  const picture = document.getElementById('restaurant-picture');
  picture.className = 'restaurant-picture';
  const src1 = document.getElementById('source-1');
  src1.media = "(min-width: 750px)";
  src1.srcset = `${DBHelper.imageUrlBasePath}${DBHelper.imageNameForRestaurant(restaurant)}-800_large_1x.jpg 1x`;
  src1.srcset += `,${DBHelper.imageUrlBasePath}${DBHelper.imageNameForRestaurant(restaurant)}-1200_large_2x.jpg 2x`;
  const src2 = document.getElementById('source-2');
  src2.media = "(min-width: 500px)";
  src2.srcset = `${DBHelper.imageUrlBasePath}${DBHelper.imageNameForRestaurant(restaurant)}-medium.jpg`;
  const image = document.getElementById('restaurant-img');
  image.className = 'restaurant-img';
  image.src = DBHelper.imageUrlForRestaurant(restaurant);
  image.alt = "Image of the restaurant " + restaurant.name;
  const cuisine = document.getElementById('restaurant-cuisine');
  cuisine.innerHTML = restaurant.cuisine_type; // fill operating hours

  if (restaurant.operating_hours) {
    fillRestaurantHoursHTML();
  } // fill reviews


  fillReviewsHTML();
};
/**
 * Create restaurant operating hours HTML table and add it to the webpage.
 */


fillRestaurantHoursHTML = (operatingHours = self.restaurant.operating_hours) => {
  const hours = document.getElementById('restaurant-hours');

  for (let key in operatingHours) {
    const row = document.createElement('tr');
    const day = document.createElement('td');
    day.innerHTML = key;
    row.appendChild(day);
    const time = document.createElement('td');
    time.innerHTML = operatingHours[key];
    row.appendChild(time);
    hours.appendChild(row);
  }
};
/**
 * Create all reviews HTML and add them to the webpage.
 */


fillReviewsHTML = (reviews = self.restaurant.reviews) => {
  if (!reviews) {
    worker.postMessage({
      cmd: 'fetch_reviews',
      id: self.restaurant.id
    });
  } else {
    generateReviewsHTML(reviews);
  }
};
/**
 * Generate reviews HTML
 */


generateReviewsHTML = reviews => {
  const container = document.getElementById('reviews-container');
  const reviewsMsg = document.getElementById('reviews-message');

  if (!reviews) {
    reviewsMsg.innerHTML = 'No reviews yet!';
    return;
  }

  const ul = document.getElementById('reviews-list');
  ul.innerHTML = '';
  reviewsMsg.innerHTML = '';
  reviews.forEach(review => {
    ul.appendChild(createReviewHTML(review));
  });
};
/**
 * Create review HTML and add it to the webpage.
 */


createReviewHTML = review => {
  const li = document.createElement('li');
  const div = document.createElement('div');
  div.className = "review-header";
  li.appendChild(div);
  const name = document.createElement('h3');
  name.innerHTML = review.name;
  div.appendChild(name);
  const date = document.createElement('span');
  date.innerHTML = review.date;
  date.className = "review-date";
  div.appendChild(date);
  const body = document.createElement('div');
  body.className = "review-body";
  li.appendChild(body);
  const rating = document.createElement('span');
  rating.innerHTML = `Rating: ${review.rating}`;
  rating.className = "review-rating";
  body.appendChild(rating);
  const comments = document.createElement('p');
  comments.innerHTML = review.comments;
  body.appendChild(comments);
  return li;
};
/**
 * Add restaurant name to the breadcrumb navigation menu
 */


fillBreadcrumb = (restaurant = self.restaurant) => {
  const breadcrumb = document.getElementById('breadcrumb');
  const li = document.createElement('li');
  li.innerHTML = restaurant.name;
  breadcrumb.appendChild(li);
};
/**
 * Get a parameter by name from page URL.
 */


getParameterByName = (name, url) => {
  if (!url) url = window.location.href;
  name = name.replace(/[\[\]]/g, '\\$&');
  const regex = new RegExp(`[?&]${name}(=([^&#]*)|&|#|$)`),
        results = regex.exec(url);
  if (!results) return null;
  if (!results[2]) return '';
  return decodeURIComponent(results[2].replace(/\+/g, ' '));
};
/**
 * Expand add review  
 */


const addReviewButton = document.getElementById('add-review');
addReviewButton.addEventListener('click', e => {
  e.preventDefault();
  const form = document.getElementById('submit-review');
  form.style.display = 'block';
  addReviewButton.setAttribute('aria-expanded', true);
});
/**
 * Post review
 */

const postReviewButton = document.getElementById('post-review');
postReviewButton.addEventListener('click', e => {
  e.preventDefault();
  const name = document.getElementById('name');
  const comments = document.getElementById('comments');
  const rating = document.getElementById('rating'); // Validate review fields

  if (name.value === '' || comments.value === '' || rating.value === '') return;
  const review = {};
  review.name = name.value;
  review.rating = rating.value;
  review.comments = comments.value;
  review.date = moment().format('MMMM D, YYYY');
  review.synced = false; // Reset values

  name.value = '';
  comments.value = '';
  rating.value = -1; // Fetch restaurant from DB

  DBHelper.fetchRestaurantById(self.restaurant.id, (error, restaurant) => {
    if (restaurant) {
      self.restaurant = restaurant;

      if (Array.isArray(self.restaurant.reviews)) {
        self.restaurant.reviews.push(review);
      } else {
        self.restaurant.reviews = [];
        self.restaurant.reviews.push(review);
      }

      DBHelper.updateRestaurantReviews(self.restaurant).then(result => {
        if (result) {
          const form = document.getElementById('submit-review');
          form.style.display = 'none';
          addReviewButton.setAttribute('aria-expanded', false);
          const toast = Toast.create({
            text: "Review submitted."
          });
          Toast.setTimeout(toast.id, 2000);
          fillReviewsHTML();
        }
      });
    }
  });
});
/**
 * Offline event handler
 */

window.addEventListener('offline', () => {
  const toast = Toast.create({
    text: "Unable to connect. Retrying..."
  });
  Toast.setTimeout(toast.id, 5000);
});
/**
 * Online event handler
 */

window.addEventListener('online', () => {
  worker.postMessage({
    cmd: 'sync_reviews'
  });
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJlc3RhdXJhbnRfaW5mby5qcyJdLCJuYW1lcyI6WyJyZXN0YXVyYW50IiwibmV3TWFwIiwiZG9jdW1lbnQiLCJhZGRFdmVudExpc3RlbmVyIiwiZXZlbnQiLCJpbml0TWFwIiwicmVnaXN0ZXJTZXJ2aWNlV29ya2VyIiwid29ya2VyIiwiV29ya2VyIiwiZSIsImRhdGEiLCJjbWQiLCJlcnJvciIsImNvbnNvbGUiLCJsb2ciLCJnZW5lcmF0ZVJldmlld3NIVE1MIiwicmV2aWV3cyIsInNlbGYiLCJmaWxsUmVzdGF1cmFudEhUTUwiLCJoYW5kbGVSZXN0YXVyYW50IiwiZmV0Y2hSZXN0YXVyYW50RnJvbVVSTCIsImlkIiwiZ2V0UGFyYW1ldGVyQnlOYW1lIiwicG9zdE1lc3NhZ2UiLCJMIiwibWFwIiwiY2VudGVyIiwibGF0bG5nIiwibGF0IiwibG5nIiwiem9vbSIsInNjcm9sbFdoZWVsWm9vbSIsInRpbGVMYXllciIsIm1hcGJveFRva2VuIiwibWF4Wm9vbSIsImF0dHJpYnV0aW9uIiwiYWRkVG8iLCJmaWxsQnJlYWRjcnVtYiIsIkRCSGVscGVyIiwibWFwTWFya2VyRm9yUmVzdGF1cmFudCIsIm5hbWUiLCJnZXRFbGVtZW50QnlJZCIsImlubmVySFRNTCIsImFkZHJlc3MiLCJwaWN0dXJlIiwiY2xhc3NOYW1lIiwic3JjMSIsIm1lZGlhIiwic3Jjc2V0IiwiaW1hZ2VVcmxCYXNlUGF0aCIsImltYWdlTmFtZUZvclJlc3RhdXJhbnQiLCJzcmMyIiwiaW1hZ2UiLCJzcmMiLCJpbWFnZVVybEZvclJlc3RhdXJhbnQiLCJhbHQiLCJjdWlzaW5lIiwiY3Vpc2luZV90eXBlIiwib3BlcmF0aW5nX2hvdXJzIiwiZmlsbFJlc3RhdXJhbnRIb3Vyc0hUTUwiLCJmaWxsUmV2aWV3c0hUTUwiLCJvcGVyYXRpbmdIb3VycyIsImhvdXJzIiwia2V5Iiwicm93IiwiY3JlYXRlRWxlbWVudCIsImRheSIsImFwcGVuZENoaWxkIiwidGltZSIsImNvbnRhaW5lciIsInJldmlld3NNc2ciLCJ1bCIsImZvckVhY2giLCJyZXZpZXciLCJjcmVhdGVSZXZpZXdIVE1MIiwibGkiLCJkaXYiLCJkYXRlIiwiYm9keSIsInJhdGluZyIsImNvbW1lbnRzIiwiYnJlYWRjcnVtYiIsInVybCIsIndpbmRvdyIsImxvY2F0aW9uIiwiaHJlZiIsInJlcGxhY2UiLCJyZWdleCIsIlJlZ0V4cCIsInJlc3VsdHMiLCJleGVjIiwiZGVjb2RlVVJJQ29tcG9uZW50IiwiYWRkUmV2aWV3QnV0dG9uIiwicHJldmVudERlZmF1bHQiLCJmb3JtIiwic3R5bGUiLCJkaXNwbGF5Iiwic2V0QXR0cmlidXRlIiwicG9zdFJldmlld0J1dHRvbiIsInZhbHVlIiwibW9tZW50IiwiZm9ybWF0Iiwic3luY2VkIiwiZmV0Y2hSZXN0YXVyYW50QnlJZCIsIkFycmF5IiwiaXNBcnJheSIsInB1c2giLCJ1cGRhdGVSZXN0YXVyYW50UmV2aWV3cyIsInRoZW4iLCJyZXN1bHQiLCJ0b2FzdCIsIlRvYXN0IiwiY3JlYXRlIiwidGV4dCIsInNldFRpbWVvdXQiXSwibWFwcGluZ3MiOiJBQUFBLElBQUlBLFVBQUo7QUFDQSxJQUFJQyxNQUFKO0FBRUE7Ozs7QUFHQUMsUUFBUSxDQUFDQyxnQkFBVCxDQUEwQixrQkFBMUIsRUFBK0NDLEtBQUQsSUFBVztBQUN2REMsRUFBQUEsT0FBTztBQUNQQyxFQUFBQSxxQkFBcUI7QUFDdEIsQ0FIRDtBQUtBOzs7O0FBR0EsTUFBTUMsTUFBTSxHQUFHLElBQUlDLE1BQUosQ0FBVyxjQUFYLENBQWY7QUFDQUQsTUFBTSxDQUFDSixnQkFBUCxDQUF3QixTQUF4QixFQUFtQ00sQ0FBQyxJQUFJO0FBQ3RDLFVBQU9BLENBQUMsQ0FBQ0MsSUFBRixDQUFPQyxHQUFkO0FBQ0UsU0FBSyxlQUFMO0FBQ0UsVUFBSUYsQ0FBQyxDQUFDQyxJQUFGLENBQU9FLEtBQVgsRUFBa0I7QUFDaEJDLFFBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZTCxDQUFDLENBQUNDLElBQUYsQ0FBT0UsS0FBbkI7QUFDQTtBQUNEOztBQUVERyxNQUFBQSxtQkFBbUIsQ0FBQ04sQ0FBQyxDQUFDQyxJQUFGLENBQU9NLE9BQVIsQ0FBbkI7QUFDQTs7QUFDRixTQUFLLGtCQUFMO0FBQ0UsVUFBSVAsQ0FBQyxDQUFDQyxJQUFGLENBQU9FLEtBQVgsRUFBa0I7QUFDaEJDLFFBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZTCxDQUFDLENBQUNDLElBQUYsQ0FBT0UsS0FBbkI7QUFDQTtBQUNEOztBQUVESyxNQUFBQSxJQUFJLENBQUNqQixVQUFMLEdBQWtCUyxDQUFDLENBQUNDLElBQUYsQ0FBT1YsVUFBekI7QUFDQWtCLE1BQUFBLGtCQUFrQjtBQUNsQkMsTUFBQUEsZ0JBQWdCLENBQUMsSUFBRCxFQUFPRixJQUFJLENBQUNqQixVQUFaLENBQWhCO0FBQ0E7QUFsQko7QUFvQkQsQ0FyQkQ7QUF1QkE7Ozs7QUFHQUssT0FBTyxHQUFHLE1BQU07QUFDZGUsRUFBQUEsc0JBQXNCO0FBQ3ZCLENBRkQ7QUFJQTs7Ozs7QUFHQUEsc0JBQXNCLEdBQUcsTUFBTTtBQUM3QixNQUFJSCxJQUFJLENBQUNqQixVQUFULEVBQXFCO0FBQUU7QUFDckJtQixJQUFBQSxnQkFBZ0IsQ0FBQyxJQUFELEVBQU9GLElBQUksQ0FBQ2pCLFVBQVosQ0FBaEI7QUFDQTtBQUNEOztBQUVELFFBQU1xQixFQUFFLEdBQUdDLGtCQUFrQixDQUFDLElBQUQsQ0FBN0I7O0FBQ0EsTUFBSSxDQUFDRCxFQUFMLEVBQVM7QUFBRTtBQUNUVCxJQUFBQSxLQUFLLEdBQUcseUJBQVI7QUFDQU8sSUFBQUEsZ0JBQWdCLENBQUNQLEtBQUQsRUFBUSxJQUFSLENBQWhCO0FBQ0QsR0FIRCxNQUlLO0FBQ0hMLElBQUFBLE1BQU0sQ0FBQ2dCLFdBQVAsQ0FBbUI7QUFDakJaLE1BQUFBLEdBQUcsRUFBRSxrQkFEWTtBQUVqQlUsTUFBQUEsRUFBRSxFQUFFQTtBQUZhLEtBQW5CO0FBSUQ7QUFDRixDQWpCRDtBQW1CQTs7Ozs7QUFHQUYsZ0JBQWdCLEdBQUcsQ0FBQ1AsS0FBRCxFQUFRWixVQUFSLEtBQXVCO0FBQ3hDLE1BQUlZLEtBQUosRUFBVztBQUFFO0FBQ1hDLElBQUFBLE9BQU8sQ0FBQ0QsS0FBUixDQUFjQSxLQUFkO0FBQ0QsR0FGRCxNQUdLO0FBQ0hLLElBQUFBLElBQUksQ0FBQ2hCLE1BQUwsR0FBY3VCLENBQUMsQ0FBQ0MsR0FBRixDQUFNLEtBQU4sRUFBYTtBQUN6QkMsTUFBQUEsTUFBTSxFQUFFLENBQUMxQixVQUFVLENBQUMyQixNQUFYLENBQWtCQyxHQUFuQixFQUF3QjVCLFVBQVUsQ0FBQzJCLE1BQVgsQ0FBa0JFLEdBQTFDLENBRGlCO0FBRXpCQyxNQUFBQSxJQUFJLEVBQUUsRUFGbUI7QUFHekJDLE1BQUFBLGVBQWUsRUFBRTtBQUhRLEtBQWIsQ0FBZDtBQUtBUCxJQUFBQSxDQUFDLENBQUNRLFNBQUYsQ0FBWSxtRkFBWixFQUFpRztBQUMvRkMsTUFBQUEsV0FBVyxFQUFFLHVGQURrRjtBQUUvRkMsTUFBQUEsT0FBTyxFQUFFLEVBRnNGO0FBRy9GQyxNQUFBQSxXQUFXLEVBQUUsOEZBQ1gsMEVBRFcsR0FFWCx3REFMNkY7QUFNL0ZkLE1BQUFBLEVBQUUsRUFBRTtBQU4yRixLQUFqRyxFQU9HZSxLQVBILENBT1NuQyxNQVBUO0FBUUFvQyxJQUFBQSxjQUFjO0FBQ2RDLElBQUFBLFFBQVEsQ0FBQ0Msc0JBQVQsQ0FBZ0N0QixJQUFJLENBQUNqQixVQUFyQyxFQUFpRGlCLElBQUksQ0FBQ2hCLE1BQXREO0FBQ0Q7QUFDRixDQXJCRDtBQXVCQTs7Ozs7QUFHQWlCLGtCQUFrQixHQUFHLENBQUNsQixVQUFVLEdBQUdpQixJQUFJLENBQUNqQixVQUFuQixLQUFrQztBQUNyRCxRQUFNd0MsSUFBSSxHQUFHdEMsUUFBUSxDQUFDdUMsY0FBVCxDQUF3QixpQkFBeEIsQ0FBYjtBQUNBRCxFQUFBQSxJQUFJLENBQUNFLFNBQUwsR0FBaUIxQyxVQUFVLENBQUN3QyxJQUE1QjtBQUVBLFFBQU1HLE9BQU8sR0FBR3pDLFFBQVEsQ0FBQ3VDLGNBQVQsQ0FBd0Isb0JBQXhCLENBQWhCO0FBQ0FFLEVBQUFBLE9BQU8sQ0FBQ0QsU0FBUixHQUFvQjFDLFVBQVUsQ0FBQzJDLE9BQS9CO0FBRUEsUUFBTUMsT0FBTyxHQUFHMUMsUUFBUSxDQUFDdUMsY0FBVCxDQUF3QixvQkFBeEIsQ0FBaEI7QUFDQUcsRUFBQUEsT0FBTyxDQUFDQyxTQUFSLEdBQW9CLG9CQUFwQjtBQUVBLFFBQU1DLElBQUksR0FBRzVDLFFBQVEsQ0FBQ3VDLGNBQVQsQ0FBd0IsVUFBeEIsQ0FBYjtBQUNBSyxFQUFBQSxJQUFJLENBQUNDLEtBQUwsR0FBYSxvQkFBYjtBQUNBRCxFQUFBQSxJQUFJLENBQUNFLE1BQUwsR0FBZSxHQUFFVixRQUFRLENBQUNXLGdCQUFpQixHQUFFWCxRQUFRLENBQUNZLHNCQUFULENBQWdDbEQsVUFBaEMsQ0FBNEMsc0JBQXpGO0FBQ0E4QyxFQUFBQSxJQUFJLENBQUNFLE1BQUwsSUFBZ0IsSUFBR1YsUUFBUSxDQUFDVyxnQkFBaUIsR0FBRVgsUUFBUSxDQUFDWSxzQkFBVCxDQUFnQ2xELFVBQWhDLENBQTRDLHVCQUEzRjtBQUVBLFFBQU1tRCxJQUFJLEdBQUdqRCxRQUFRLENBQUN1QyxjQUFULENBQXdCLFVBQXhCLENBQWI7QUFDQVUsRUFBQUEsSUFBSSxDQUFDSixLQUFMLEdBQWEsb0JBQWI7QUFDQUksRUFBQUEsSUFBSSxDQUFDSCxNQUFMLEdBQWUsR0FBRVYsUUFBUSxDQUFDVyxnQkFBaUIsR0FBRVgsUUFBUSxDQUFDWSxzQkFBVCxDQUFnQ2xELFVBQWhDLENBQTRDLGFBQXpGO0FBRUEsUUFBTW9ELEtBQUssR0FBR2xELFFBQVEsQ0FBQ3VDLGNBQVQsQ0FBd0IsZ0JBQXhCLENBQWQ7QUFDQVcsRUFBQUEsS0FBSyxDQUFDUCxTQUFOLEdBQWtCLGdCQUFsQjtBQUNBTyxFQUFBQSxLQUFLLENBQUNDLEdBQU4sR0FBWWYsUUFBUSxDQUFDZ0IscUJBQVQsQ0FBK0J0RCxVQUEvQixDQUFaO0FBQ0FvRCxFQUFBQSxLQUFLLENBQUNHLEdBQU4sR0FBWSw2QkFBNkJ2RCxVQUFVLENBQUN3QyxJQUFwRDtBQUVBLFFBQU1nQixPQUFPLEdBQUd0RCxRQUFRLENBQUN1QyxjQUFULENBQXdCLG9CQUF4QixDQUFoQjtBQUNBZSxFQUFBQSxPQUFPLENBQUNkLFNBQVIsR0FBb0IxQyxVQUFVLENBQUN5RCxZQUEvQixDQXpCcUQsQ0EyQnJEOztBQUNBLE1BQUl6RCxVQUFVLENBQUMwRCxlQUFmLEVBQWdDO0FBQzlCQyxJQUFBQSx1QkFBdUI7QUFDeEIsR0E5Qm9ELENBK0JyRDs7O0FBQ0FDLEVBQUFBLGVBQWU7QUFDaEIsQ0FqQ0Q7QUFtQ0E7Ozs7O0FBR0FELHVCQUF1QixHQUFHLENBQUNFLGNBQWMsR0FBRzVDLElBQUksQ0FBQ2pCLFVBQUwsQ0FBZ0IwRCxlQUFsQyxLQUFzRDtBQUM5RSxRQUFNSSxLQUFLLEdBQUc1RCxRQUFRLENBQUN1QyxjQUFULENBQXdCLGtCQUF4QixDQUFkOztBQUNBLE9BQUssSUFBSXNCLEdBQVQsSUFBZ0JGLGNBQWhCLEVBQWdDO0FBQzlCLFVBQU1HLEdBQUcsR0FBRzlELFFBQVEsQ0FBQytELGFBQVQsQ0FBdUIsSUFBdkIsQ0FBWjtBQUVBLFVBQU1DLEdBQUcsR0FBR2hFLFFBQVEsQ0FBQytELGFBQVQsQ0FBdUIsSUFBdkIsQ0FBWjtBQUNBQyxJQUFBQSxHQUFHLENBQUN4QixTQUFKLEdBQWdCcUIsR0FBaEI7QUFDQUMsSUFBQUEsR0FBRyxDQUFDRyxXQUFKLENBQWdCRCxHQUFoQjtBQUVBLFVBQU1FLElBQUksR0FBR2xFLFFBQVEsQ0FBQytELGFBQVQsQ0FBdUIsSUFBdkIsQ0FBYjtBQUNBRyxJQUFBQSxJQUFJLENBQUMxQixTQUFMLEdBQWlCbUIsY0FBYyxDQUFDRSxHQUFELENBQS9CO0FBQ0FDLElBQUFBLEdBQUcsQ0FBQ0csV0FBSixDQUFnQkMsSUFBaEI7QUFFQU4sSUFBQUEsS0FBSyxDQUFDSyxXQUFOLENBQWtCSCxHQUFsQjtBQUNEO0FBQ0YsQ0FmRDtBQWlCQTs7Ozs7QUFHQUosZUFBZSxHQUFHLENBQUM1QyxPQUFPLEdBQUdDLElBQUksQ0FBQ2pCLFVBQUwsQ0FBZ0JnQixPQUEzQixLQUF1QztBQUN2RCxNQUFJLENBQUNBLE9BQUwsRUFBYztBQUNaVCxJQUFBQSxNQUFNLENBQUNnQixXQUFQLENBQW1CO0FBQ2pCWixNQUFBQSxHQUFHLEVBQUUsZUFEWTtBQUVqQlUsTUFBQUEsRUFBRSxFQUFFSixJQUFJLENBQUNqQixVQUFMLENBQWdCcUI7QUFGSCxLQUFuQjtBQUlELEdBTEQsTUFNSztBQUNITixJQUFBQSxtQkFBbUIsQ0FBQ0MsT0FBRCxDQUFuQjtBQUNEO0FBQ0YsQ0FWRDtBQVlBOzs7OztBQUdBRCxtQkFBbUIsR0FBR0MsT0FBTyxJQUFJO0FBQy9CLFFBQU1xRCxTQUFTLEdBQUduRSxRQUFRLENBQUN1QyxjQUFULENBQXdCLG1CQUF4QixDQUFsQjtBQUNBLFFBQU02QixVQUFVLEdBQUdwRSxRQUFRLENBQUN1QyxjQUFULENBQXdCLGlCQUF4QixDQUFuQjs7QUFFQSxNQUFJLENBQUN6QixPQUFMLEVBQWM7QUFDWnNELElBQUFBLFVBQVUsQ0FBQzVCLFNBQVgsR0FBdUIsaUJBQXZCO0FBQ0E7QUFDRDs7QUFFRCxRQUFNNkIsRUFBRSxHQUFHckUsUUFBUSxDQUFDdUMsY0FBVCxDQUF3QixjQUF4QixDQUFYO0FBQ0E4QixFQUFBQSxFQUFFLENBQUM3QixTQUFILEdBQWUsRUFBZjtBQUNBNEIsRUFBQUEsVUFBVSxDQUFDNUIsU0FBWCxHQUF1QixFQUF2QjtBQUNBMUIsRUFBQUEsT0FBTyxDQUFDd0QsT0FBUixDQUFnQkMsTUFBTSxJQUFJO0FBQ3hCRixJQUFBQSxFQUFFLENBQUNKLFdBQUgsQ0FBZU8sZ0JBQWdCLENBQUNELE1BQUQsQ0FBL0I7QUFDRCxHQUZEO0FBR0QsQ0FmRDtBQWlCQTs7Ozs7QUFHQUMsZ0JBQWdCLEdBQUlELE1BQUQsSUFBWTtBQUM3QixRQUFNRSxFQUFFLEdBQUd6RSxRQUFRLENBQUMrRCxhQUFULENBQXVCLElBQXZCLENBQVg7QUFDQSxRQUFNVyxHQUFHLEdBQUcxRSxRQUFRLENBQUMrRCxhQUFULENBQXVCLEtBQXZCLENBQVo7QUFDQVcsRUFBQUEsR0FBRyxDQUFDL0IsU0FBSixHQUFnQixlQUFoQjtBQUNBOEIsRUFBQUEsRUFBRSxDQUFDUixXQUFILENBQWVTLEdBQWY7QUFFQSxRQUFNcEMsSUFBSSxHQUFHdEMsUUFBUSxDQUFDK0QsYUFBVCxDQUF1QixJQUF2QixDQUFiO0FBQ0F6QixFQUFBQSxJQUFJLENBQUNFLFNBQUwsR0FBaUIrQixNQUFNLENBQUNqQyxJQUF4QjtBQUNBb0MsRUFBQUEsR0FBRyxDQUFDVCxXQUFKLENBQWdCM0IsSUFBaEI7QUFFQSxRQUFNcUMsSUFBSSxHQUFHM0UsUUFBUSxDQUFDK0QsYUFBVCxDQUF1QixNQUF2QixDQUFiO0FBQ0FZLEVBQUFBLElBQUksQ0FBQ25DLFNBQUwsR0FBaUIrQixNQUFNLENBQUNJLElBQXhCO0FBQ0FBLEVBQUFBLElBQUksQ0FBQ2hDLFNBQUwsR0FBaUIsYUFBakI7QUFDQStCLEVBQUFBLEdBQUcsQ0FBQ1QsV0FBSixDQUFnQlUsSUFBaEI7QUFFQSxRQUFNQyxJQUFJLEdBQUc1RSxRQUFRLENBQUMrRCxhQUFULENBQXVCLEtBQXZCLENBQWI7QUFDQWEsRUFBQUEsSUFBSSxDQUFDakMsU0FBTCxHQUFpQixhQUFqQjtBQUNBOEIsRUFBQUEsRUFBRSxDQUFDUixXQUFILENBQWVXLElBQWY7QUFFQSxRQUFNQyxNQUFNLEdBQUc3RSxRQUFRLENBQUMrRCxhQUFULENBQXVCLE1BQXZCLENBQWY7QUFDQWMsRUFBQUEsTUFBTSxDQUFDckMsU0FBUCxHQUFvQixXQUFVK0IsTUFBTSxDQUFDTSxNQUFPLEVBQTVDO0FBQ0FBLEVBQUFBLE1BQU0sQ0FBQ2xDLFNBQVAsR0FBbUIsZUFBbkI7QUFDQWlDLEVBQUFBLElBQUksQ0FBQ1gsV0FBTCxDQUFpQlksTUFBakI7QUFFQSxRQUFNQyxRQUFRLEdBQUc5RSxRQUFRLENBQUMrRCxhQUFULENBQXVCLEdBQXZCLENBQWpCO0FBQ0FlLEVBQUFBLFFBQVEsQ0FBQ3RDLFNBQVQsR0FBcUIrQixNQUFNLENBQUNPLFFBQTVCO0FBQ0FGLEVBQUFBLElBQUksQ0FBQ1gsV0FBTCxDQUFpQmEsUUFBakI7QUFFQSxTQUFPTCxFQUFQO0FBQ0QsQ0E3QkQ7QUErQkE7Ozs7O0FBR0F0QyxjQUFjLEdBQUcsQ0FBQ3JDLFVBQVUsR0FBQ2lCLElBQUksQ0FBQ2pCLFVBQWpCLEtBQWdDO0FBQy9DLFFBQU1pRixVQUFVLEdBQUcvRSxRQUFRLENBQUN1QyxjQUFULENBQXdCLFlBQXhCLENBQW5CO0FBQ0EsUUFBTWtDLEVBQUUsR0FBR3pFLFFBQVEsQ0FBQytELGFBQVQsQ0FBdUIsSUFBdkIsQ0FBWDtBQUNBVSxFQUFBQSxFQUFFLENBQUNqQyxTQUFILEdBQWUxQyxVQUFVLENBQUN3QyxJQUExQjtBQUNBeUMsRUFBQUEsVUFBVSxDQUFDZCxXQUFYLENBQXVCUSxFQUF2QjtBQUNELENBTEQ7QUFPQTs7Ozs7QUFHQXJELGtCQUFrQixHQUFHLENBQUNrQixJQUFELEVBQU8wQyxHQUFQLEtBQWU7QUFDbEMsTUFBSSxDQUFDQSxHQUFMLEVBQ0VBLEdBQUcsR0FBR0MsTUFBTSxDQUFDQyxRQUFQLENBQWdCQyxJQUF0QjtBQUNGN0MsRUFBQUEsSUFBSSxHQUFHQSxJQUFJLENBQUM4QyxPQUFMLENBQWEsU0FBYixFQUF3QixNQUF4QixDQUFQO0FBQ0EsUUFBTUMsS0FBSyxHQUFHLElBQUlDLE1BQUosQ0FBWSxPQUFNaEQsSUFBSyxtQkFBdkIsQ0FBZDtBQUFBLFFBQ0VpRCxPQUFPLEdBQUdGLEtBQUssQ0FBQ0csSUFBTixDQUFXUixHQUFYLENBRFo7QUFFQSxNQUFJLENBQUNPLE9BQUwsRUFDRSxPQUFPLElBQVA7QUFDRixNQUFJLENBQUNBLE9BQU8sQ0FBQyxDQUFELENBQVosRUFDRSxPQUFPLEVBQVA7QUFDRixTQUFPRSxrQkFBa0IsQ0FBQ0YsT0FBTyxDQUFDLENBQUQsQ0FBUCxDQUFXSCxPQUFYLENBQW1CLEtBQW5CLEVBQTBCLEdBQTFCLENBQUQsQ0FBekI7QUFDRCxDQVhEO0FBYUE7Ozs7O0FBR0EsTUFBTU0sZUFBZSxHQUFHMUYsUUFBUSxDQUFDdUMsY0FBVCxDQUF3QixZQUF4QixDQUF4QjtBQUNBbUQsZUFBZSxDQUFDekYsZ0JBQWhCLENBQWlDLE9BQWpDLEVBQTBDTSxDQUFDLElBQUk7QUFDN0NBLEVBQUFBLENBQUMsQ0FBQ29GLGNBQUY7QUFDQSxRQUFNQyxJQUFJLEdBQUc1RixRQUFRLENBQUN1QyxjQUFULENBQXdCLGVBQXhCLENBQWI7QUFDQXFELEVBQUFBLElBQUksQ0FBQ0MsS0FBTCxDQUFXQyxPQUFYLEdBQXFCLE9BQXJCO0FBQ0FKLEVBQUFBLGVBQWUsQ0FBQ0ssWUFBaEIsQ0FBNkIsZUFBN0IsRUFBOEMsSUFBOUM7QUFDRCxDQUxEO0FBT0E7Ozs7QUFHQSxNQUFNQyxnQkFBZ0IsR0FBR2hHLFFBQVEsQ0FBQ3VDLGNBQVQsQ0FBd0IsYUFBeEIsQ0FBekI7QUFDQXlELGdCQUFnQixDQUFDL0YsZ0JBQWpCLENBQWtDLE9BQWxDLEVBQTJDTSxDQUFDLElBQUk7QUFDOUNBLEVBQUFBLENBQUMsQ0FBQ29GLGNBQUY7QUFFQSxRQUFNckQsSUFBSSxHQUFHdEMsUUFBUSxDQUFDdUMsY0FBVCxDQUF3QixNQUF4QixDQUFiO0FBQ0EsUUFBTXVDLFFBQVEsR0FBRzlFLFFBQVEsQ0FBQ3VDLGNBQVQsQ0FBd0IsVUFBeEIsQ0FBakI7QUFDQSxRQUFNc0MsTUFBTSxHQUFHN0UsUUFBUSxDQUFDdUMsY0FBVCxDQUF3QixRQUF4QixDQUFmLENBTDhDLENBTzlDOztBQUNBLE1BQUlELElBQUksQ0FBQzJELEtBQUwsS0FBZSxFQUFmLElBQXFCbkIsUUFBUSxDQUFDbUIsS0FBVCxLQUFtQixFQUF4QyxJQUE4Q3BCLE1BQU0sQ0FBQ29CLEtBQVAsS0FBaUIsRUFBbkUsRUFBdUU7QUFFdkUsUUFBTTFCLE1BQU0sR0FBRyxFQUFmO0FBQ0FBLEVBQUFBLE1BQU0sQ0FBQ2pDLElBQVAsR0FBY0EsSUFBSSxDQUFDMkQsS0FBbkI7QUFDQTFCLEVBQUFBLE1BQU0sQ0FBQ00sTUFBUCxHQUFnQkEsTUFBTSxDQUFDb0IsS0FBdkI7QUFDQTFCLEVBQUFBLE1BQU0sQ0FBQ08sUUFBUCxHQUFrQkEsUUFBUSxDQUFDbUIsS0FBM0I7QUFDQTFCLEVBQUFBLE1BQU0sQ0FBQ0ksSUFBUCxHQUFjdUIsTUFBTSxHQUFHQyxNQUFULENBQWdCLGNBQWhCLENBQWQ7QUFDQTVCLEVBQUFBLE1BQU0sQ0FBQzZCLE1BQVAsR0FBZ0IsS0FBaEIsQ0FmOEMsQ0FpQjlDOztBQUNBOUQsRUFBQUEsSUFBSSxDQUFDMkQsS0FBTCxHQUFhLEVBQWI7QUFDQW5CLEVBQUFBLFFBQVEsQ0FBQ21CLEtBQVQsR0FBaUIsRUFBakI7QUFDQXBCLEVBQUFBLE1BQU0sQ0FBQ29CLEtBQVAsR0FBZSxDQUFDLENBQWhCLENBcEI4QyxDQXNCOUM7O0FBQ0E3RCxFQUFBQSxRQUFRLENBQUNpRSxtQkFBVCxDQUE2QnRGLElBQUksQ0FBQ2pCLFVBQUwsQ0FBZ0JxQixFQUE3QyxFQUFpRCxDQUFDVCxLQUFELEVBQVFaLFVBQVIsS0FBdUI7QUFDdEUsUUFBSUEsVUFBSixFQUFnQjtBQUNkaUIsTUFBQUEsSUFBSSxDQUFDakIsVUFBTCxHQUFrQkEsVUFBbEI7O0FBRUEsVUFBSXdHLEtBQUssQ0FBQ0MsT0FBTixDQUFjeEYsSUFBSSxDQUFDakIsVUFBTCxDQUFnQmdCLE9BQTlCLENBQUosRUFBNEM7QUFDMUNDLFFBQUFBLElBQUksQ0FBQ2pCLFVBQUwsQ0FBZ0JnQixPQUFoQixDQUF3QjBGLElBQXhCLENBQTZCakMsTUFBN0I7QUFDRCxPQUZELE1BR0s7QUFDSHhELFFBQUFBLElBQUksQ0FBQ2pCLFVBQUwsQ0FBZ0JnQixPQUFoQixHQUEwQixFQUExQjtBQUNBQyxRQUFBQSxJQUFJLENBQUNqQixVQUFMLENBQWdCZ0IsT0FBaEIsQ0FBd0IwRixJQUF4QixDQUE2QmpDLE1BQTdCO0FBQ0Q7O0FBRURuQyxNQUFBQSxRQUFRLENBQUNxRSx1QkFBVCxDQUFpQzFGLElBQUksQ0FBQ2pCLFVBQXRDLEVBQWtENEcsSUFBbEQsQ0FBdURDLE1BQU0sSUFBSTtBQUMvRCxZQUFJQSxNQUFKLEVBQVk7QUFDVixnQkFBTWYsSUFBSSxHQUFHNUYsUUFBUSxDQUFDdUMsY0FBVCxDQUF3QixlQUF4QixDQUFiO0FBQ0FxRCxVQUFBQSxJQUFJLENBQUNDLEtBQUwsQ0FBV0MsT0FBWCxHQUFxQixNQUFyQjtBQUVBSixVQUFBQSxlQUFlLENBQUNLLFlBQWhCLENBQTZCLGVBQTdCLEVBQThDLEtBQTlDO0FBRUEsZ0JBQU1hLEtBQUssR0FBR0MsS0FBSyxDQUFDQyxNQUFOLENBQWE7QUFDekJDLFlBQUFBLElBQUksRUFBRTtBQURtQixXQUFiLENBQWQ7QUFHQUYsVUFBQUEsS0FBSyxDQUFDRyxVQUFOLENBQWlCSixLQUFLLENBQUN6RixFQUF2QixFQUEyQixJQUEzQjtBQUVBdUMsVUFBQUEsZUFBZTtBQUNoQjtBQUNGLE9BZEQ7QUFlRDtBQUNGLEdBNUJEO0FBNkJELENBcEREO0FBc0RBOzs7O0FBR0F1QixNQUFNLENBQUNoRixnQkFBUCxDQUF3QixTQUF4QixFQUFtQyxNQUFNO0FBQ3ZDLFFBQU0yRyxLQUFLLEdBQUdDLEtBQUssQ0FBQ0MsTUFBTixDQUFhO0FBQ3pCQyxJQUFBQSxJQUFJLEVBQUU7QUFEbUIsR0FBYixDQUFkO0FBSUFGLEVBQUFBLEtBQUssQ0FBQ0csVUFBTixDQUFpQkosS0FBSyxDQUFDekYsRUFBdkIsRUFBMkIsSUFBM0I7QUFDRCxDQU5EO0FBUUE7Ozs7QUFHQThELE1BQU0sQ0FBQ2hGLGdCQUFQLENBQXdCLFFBQXhCLEVBQWtDLE1BQU07QUFDdENJLEVBQUFBLE1BQU0sQ0FBQ2dCLFdBQVAsQ0FBbUI7QUFDakJaLElBQUFBLEdBQUcsRUFBRTtBQURZLEdBQW5CO0FBR0QsQ0FKRCIsInNvdXJjZXNDb250ZW50IjpbImxldCByZXN0YXVyYW50O1xudmFyIG5ld01hcDtcblxuLyoqXG4gKiBJbml0aWFsaXplIG1hcCBhcyBzb29uIGFzIHRoZSBwYWdlIGlzIGxvYWRlZC5cbiAqL1xuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIChldmVudCkgPT4geyAgXG4gIGluaXRNYXAoKTtcbiAgcmVnaXN0ZXJTZXJ2aWNlV29ya2VyKCk7XG59KTtcblxuLyoqXG4gKiBJbml0aWFsaXplIHdvcmtlclxuICovXG5jb25zdCB3b3JrZXIgPSBuZXcgV29ya2VyKCdqcy93b3JrZXIuanMnKTtcbndvcmtlci5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgZSA9PiB7XG4gIHN3aXRjaChlLmRhdGEuY21kKSB7XG4gICAgY2FzZSAnZmV0Y2hfcmV2aWV3cyc6XG4gICAgICBpZiAoZS5kYXRhLmVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGUuZGF0YS5lcnJvcik7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgZ2VuZXJhdGVSZXZpZXdzSFRNTChlLmRhdGEucmV2aWV3cyk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdmZXRjaF9yZXN0YXVyYW50JzpcbiAgICAgIGlmIChlLmRhdGEuZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5sb2coZS5kYXRhLmVycm9yKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBzZWxmLnJlc3RhdXJhbnQgPSBlLmRhdGEucmVzdGF1cmFudDtcbiAgICAgIGZpbGxSZXN0YXVyYW50SFRNTCgpO1xuICAgICAgaGFuZGxlUmVzdGF1cmFudChudWxsLCBzZWxmLnJlc3RhdXJhbnQpO1xuICAgICAgYnJlYWs7XG4gIH1cbn0pO1xuXG4vKipcbiAqIEluaXRpYWxpemUgbGVhZmxldCBtYXBcbiAqL1xuaW5pdE1hcCA9ICgpID0+IHtcbiAgZmV0Y2hSZXN0YXVyYW50RnJvbVVSTCgpO1xufSAgXG4gXG4vKipcbiAqIEdldCBjdXJyZW50IHJlc3RhdXJhbnQgZnJvbSBwYWdlIFVSTC5cbiAqL1xuZmV0Y2hSZXN0YXVyYW50RnJvbVVSTCA9ICgpID0+IHtcbiAgaWYgKHNlbGYucmVzdGF1cmFudCkgeyAvLyByZXN0YXVyYW50IGFscmVhZHkgZmV0Y2hlZCFcbiAgICBoYW5kbGVSZXN0YXVyYW50KG51bGwsIHNlbGYucmVzdGF1cmFudClcbiAgICByZXR1cm47XG4gIH1cbiAgXG4gIGNvbnN0IGlkID0gZ2V0UGFyYW1ldGVyQnlOYW1lKCdpZCcpO1xuICBpZiAoIWlkKSB7IC8vIG5vIGlkIGZvdW5kIGluIFVSTFxuICAgIGVycm9yID0gJ05vIHJlc3RhdXJhbnQgaWQgaW4gVVJMJ1xuICAgIGhhbmRsZVJlc3RhdXJhbnQoZXJyb3IsIG51bGwpO1xuICB9IFxuICBlbHNlIHtcbiAgICB3b3JrZXIucG9zdE1lc3NhZ2Uoe1xuICAgICAgY21kOiAnZmV0Y2hfcmVzdGF1cmFudCcsXG4gICAgICBpZDogaWRcbiAgICB9KTtcbiAgfVxufVxuXG4vKipcbiAqIEhhbmRsZSByZXN0YXVyYW50IGNhbGxiYWNrXG4gKi9cbmhhbmRsZVJlc3RhdXJhbnQgPSAoZXJyb3IsIHJlc3RhdXJhbnQpID0+IHtcbiAgaWYgKGVycm9yKSB7IC8vIEdvdCBhbiBlcnJvciFcbiAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgfSBcbiAgZWxzZSB7ICAgICAgXG4gICAgc2VsZi5uZXdNYXAgPSBMLm1hcCgnbWFwJywge1xuICAgICAgY2VudGVyOiBbcmVzdGF1cmFudC5sYXRsbmcubGF0LCByZXN0YXVyYW50LmxhdGxuZy5sbmddLFxuICAgICAgem9vbTogMTYsXG4gICAgICBzY3JvbGxXaGVlbFpvb206IGZhbHNlXG4gICAgfSk7XG4gICAgTC50aWxlTGF5ZXIoJ2h0dHBzOi8vYXBpLnRpbGVzLm1hcGJveC5jb20vdjQve2lkfS97en0ve3h9L3t5fS5qcGc3MD9hY2Nlc3NfdG9rZW49e21hcGJveFRva2VufScsIHtcbiAgICAgIG1hcGJveFRva2VuOiAncGsuZXlKMUlqb2liR1Z0WVNJc0ltRWlPaUpqYW10MFlYVmxhMk13TTNOak0zZHZaSFEwTkRJd1ptVnBJbjAucE9FRmFQWTZlbkNjaElHMjlMbzJTUScsXG4gICAgICBtYXhab29tOiAxOCxcbiAgICAgIGF0dHJpYnV0aW9uOiAnTWFwIGRhdGEgJmNvcHk7IDxhIGhyZWY9XCJodHRwczovL3d3dy5vcGVuc3RyZWV0bWFwLm9yZy9cIj5PcGVuU3RyZWV0TWFwPC9hPiBjb250cmlidXRvcnMsICcgK1xuICAgICAgICAnPGEgaHJlZj1cImh0dHBzOi8vY3JlYXRpdmVjb21tb25zLm9yZy9saWNlbnNlcy9ieS1zYS8yLjAvXCI+Q0MtQlktU0E8L2E+LCAnICtcbiAgICAgICAgJ0ltYWdlcnkgwqkgPGEgaHJlZj1cImh0dHBzOi8vd3d3Lm1hcGJveC5jb20vXCI+TWFwYm94PC9hPicsXG4gICAgICBpZDogJ21hcGJveC5zdHJlZXRzJyAgICBcbiAgICB9KS5hZGRUbyhuZXdNYXApO1xuICAgIGZpbGxCcmVhZGNydW1iKCk7XG4gICAgREJIZWxwZXIubWFwTWFya2VyRm9yUmVzdGF1cmFudChzZWxmLnJlc3RhdXJhbnQsIHNlbGYubmV3TWFwKTtcbiAgfVxufVxuXG4vKipcbiAqIENyZWF0ZSByZXN0YXVyYW50IEhUTUwgYW5kIGFkZCBpdCB0byB0aGUgd2VicGFnZVxuICovXG5maWxsUmVzdGF1cmFudEhUTUwgPSAocmVzdGF1cmFudCA9IHNlbGYucmVzdGF1cmFudCkgPT4ge1xuICBjb25zdCBuYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtbmFtZScpO1xuICBuYW1lLmlubmVySFRNTCA9IHJlc3RhdXJhbnQubmFtZTtcblxuICBjb25zdCBhZGRyZXNzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtYWRkcmVzcycpO1xuICBhZGRyZXNzLmlubmVySFRNTCA9IHJlc3RhdXJhbnQuYWRkcmVzcztcblxuICBjb25zdCBwaWN0dXJlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtcGljdHVyZScpO1xuICBwaWN0dXJlLmNsYXNzTmFtZSA9ICdyZXN0YXVyYW50LXBpY3R1cmUnO1xuXG4gIGNvbnN0IHNyYzEgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc291cmNlLTEnKTtcbiAgc3JjMS5tZWRpYSA9IFwiKG1pbi13aWR0aDogNzUwcHgpXCJcbiAgc3JjMS5zcmNzZXQgPSBgJHtEQkhlbHBlci5pbWFnZVVybEJhc2VQYXRofSR7REJIZWxwZXIuaW1hZ2VOYW1lRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KX0tODAwX2xhcmdlXzF4LmpwZyAxeGA7XG4gIHNyYzEuc3Jjc2V0ICs9IGAsJHtEQkhlbHBlci5pbWFnZVVybEJhc2VQYXRofSR7REJIZWxwZXIuaW1hZ2VOYW1lRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KX0tMTIwMF9sYXJnZV8yeC5qcGcgMnhgO1xuXG4gIGNvbnN0IHNyYzIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc291cmNlLTInKTtcbiAgc3JjMi5tZWRpYSA9IFwiKG1pbi13aWR0aDogNTAwcHgpXCJcbiAgc3JjMi5zcmNzZXQgPSBgJHtEQkhlbHBlci5pbWFnZVVybEJhc2VQYXRofSR7REJIZWxwZXIuaW1hZ2VOYW1lRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KX0tbWVkaXVtLmpwZ2A7XG5cbiAgY29uc3QgaW1hZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudC1pbWcnKTtcbiAgaW1hZ2UuY2xhc3NOYW1lID0gJ3Jlc3RhdXJhbnQtaW1nJ1xuICBpbWFnZS5zcmMgPSBEQkhlbHBlci5pbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCk7XG4gIGltYWdlLmFsdCA9IFwiSW1hZ2Ugb2YgdGhlIHJlc3RhdXJhbnQgXCIgKyByZXN0YXVyYW50Lm5hbWU7XG5cbiAgY29uc3QgY3Vpc2luZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN0YXVyYW50LWN1aXNpbmUnKTtcbiAgY3Vpc2luZS5pbm5lckhUTUwgPSByZXN0YXVyYW50LmN1aXNpbmVfdHlwZTtcblxuICAvLyBmaWxsIG9wZXJhdGluZyBob3Vyc1xuICBpZiAocmVzdGF1cmFudC5vcGVyYXRpbmdfaG91cnMpIHtcbiAgICBmaWxsUmVzdGF1cmFudEhvdXJzSFRNTCgpO1xuICB9XG4gIC8vIGZpbGwgcmV2aWV3c1xuICBmaWxsUmV2aWV3c0hUTUwoKTtcbn1cblxuLyoqXG4gKiBDcmVhdGUgcmVzdGF1cmFudCBvcGVyYXRpbmcgaG91cnMgSFRNTCB0YWJsZSBhbmQgYWRkIGl0IHRvIHRoZSB3ZWJwYWdlLlxuICovXG5maWxsUmVzdGF1cmFudEhvdXJzSFRNTCA9IChvcGVyYXRpbmdIb3VycyA9IHNlbGYucmVzdGF1cmFudC5vcGVyYXRpbmdfaG91cnMpID0+IHtcbiAgY29uc3QgaG91cnMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudC1ob3VycycpO1xuICBmb3IgKGxldCBrZXkgaW4gb3BlcmF0aW5nSG91cnMpIHtcbiAgICBjb25zdCByb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpO1xuXG4gICAgY29uc3QgZGF5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGQnKTtcbiAgICBkYXkuaW5uZXJIVE1MID0ga2V5O1xuICAgIHJvdy5hcHBlbmRDaGlsZChkYXkpO1xuXG4gICAgY29uc3QgdGltZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RkJyk7XG4gICAgdGltZS5pbm5lckhUTUwgPSBvcGVyYXRpbmdIb3Vyc1trZXldO1xuICAgIHJvdy5hcHBlbmRDaGlsZCh0aW1lKTtcblxuICAgIGhvdXJzLmFwcGVuZENoaWxkKHJvdyk7XG4gIH1cbn1cblxuLyoqXG4gKiBDcmVhdGUgYWxsIHJldmlld3MgSFRNTCBhbmQgYWRkIHRoZW0gdG8gdGhlIHdlYnBhZ2UuXG4gKi9cbmZpbGxSZXZpZXdzSFRNTCA9IChyZXZpZXdzID0gc2VsZi5yZXN0YXVyYW50LnJldmlld3MpID0+IHtcbiAgaWYgKCFyZXZpZXdzKSB7XG4gICAgd29ya2VyLnBvc3RNZXNzYWdlKHtcbiAgICAgIGNtZDogJ2ZldGNoX3Jldmlld3MnLFxuICAgICAgaWQ6IHNlbGYucmVzdGF1cmFudC5pZFxuICAgIH0pO1xuICB9XG4gIGVsc2Uge1xuICAgIGdlbmVyYXRlUmV2aWV3c0hUTUwocmV2aWV3cyk7XG4gIH1cbn1cblxuLyoqXG4gKiBHZW5lcmF0ZSByZXZpZXdzIEhUTUxcbiAqL1xuZ2VuZXJhdGVSZXZpZXdzSFRNTCA9IHJldmlld3MgPT4ge1xuICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmV2aWV3cy1jb250YWluZXInKTtcbiAgY29uc3QgcmV2aWV3c01zZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXZpZXdzLW1lc3NhZ2UnKTtcblxuICBpZiAoIXJldmlld3MpIHtcbiAgICByZXZpZXdzTXNnLmlubmVySFRNTCA9ICdObyByZXZpZXdzIHlldCEnO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jldmlld3MtbGlzdCcpO1xuICB1bC5pbm5lckhUTUwgPSAnJztcbiAgcmV2aWV3c01zZy5pbm5lckhUTUwgPSAnJztcbiAgcmV2aWV3cy5mb3JFYWNoKHJldmlldyA9PiB7XG4gICAgdWwuYXBwZW5kQ2hpbGQoY3JlYXRlUmV2aWV3SFRNTChyZXZpZXcpKTtcbiAgfSk7XG59XG5cbi8qKlxuICogQ3JlYXRlIHJldmlldyBIVE1MIGFuZCBhZGQgaXQgdG8gdGhlIHdlYnBhZ2UuXG4gKi9cbmNyZWF0ZVJldmlld0hUTUwgPSAocmV2aWV3KSA9PiB7XG4gIGNvbnN0IGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTtcbiAgY29uc3QgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gIGRpdi5jbGFzc05hbWUgPSBcInJldmlldy1oZWFkZXJcIjtcbiAgbGkuYXBwZW5kQ2hpbGQoZGl2KTtcblxuICBjb25zdCBuYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaDMnKTtcbiAgbmFtZS5pbm5lckhUTUwgPSByZXZpZXcubmFtZTtcbiAgZGl2LmFwcGVuZENoaWxkKG5hbWUpO1xuXG4gIGNvbnN0IGRhdGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XG4gIGRhdGUuaW5uZXJIVE1MID0gcmV2aWV3LmRhdGU7XG4gIGRhdGUuY2xhc3NOYW1lID0gXCJyZXZpZXctZGF0ZVwiO1xuICBkaXYuYXBwZW5kQ2hpbGQoZGF0ZSk7XG5cbiAgY29uc3QgYm9keSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICBib2R5LmNsYXNzTmFtZSA9IFwicmV2aWV3LWJvZHlcIjtcbiAgbGkuYXBwZW5kQ2hpbGQoYm9keSk7XG5cbiAgY29uc3QgcmF0aW5nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xuICByYXRpbmcuaW5uZXJIVE1MID0gYFJhdGluZzogJHtyZXZpZXcucmF0aW5nfWA7XG4gIHJhdGluZy5jbGFzc05hbWUgPSBcInJldmlldy1yYXRpbmdcIlxuICBib2R5LmFwcGVuZENoaWxkKHJhdGluZyk7XG5cbiAgY29uc3QgY29tbWVudHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XG4gIGNvbW1lbnRzLmlubmVySFRNTCA9IHJldmlldy5jb21tZW50cztcbiAgYm9keS5hcHBlbmRDaGlsZChjb21tZW50cyk7XG5cbiAgcmV0dXJuIGxpO1xufVxuXG4vKipcbiAqIEFkZCByZXN0YXVyYW50IG5hbWUgdG8gdGhlIGJyZWFkY3J1bWIgbmF2aWdhdGlvbiBtZW51XG4gKi9cbmZpbGxCcmVhZGNydW1iID0gKHJlc3RhdXJhbnQ9c2VsZi5yZXN0YXVyYW50KSA9PiB7XG4gIGNvbnN0IGJyZWFkY3J1bWIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnJlYWRjcnVtYicpO1xuICBjb25zdCBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7XG4gIGxpLmlubmVySFRNTCA9IHJlc3RhdXJhbnQubmFtZTtcbiAgYnJlYWRjcnVtYi5hcHBlbmRDaGlsZChsaSk7XG59XG5cbi8qKlxuICogR2V0IGEgcGFyYW1ldGVyIGJ5IG5hbWUgZnJvbSBwYWdlIFVSTC5cbiAqL1xuZ2V0UGFyYW1ldGVyQnlOYW1lID0gKG5hbWUsIHVybCkgPT4ge1xuICBpZiAoIXVybClcbiAgICB1cmwgPSB3aW5kb3cubG9jYXRpb24uaHJlZjtcbiAgbmFtZSA9IG5hbWUucmVwbGFjZSgvW1xcW1xcXV0vZywgJ1xcXFwkJicpO1xuICBjb25zdCByZWdleCA9IG5ldyBSZWdFeHAoYFs/Jl0ke25hbWV9KD0oW14mI10qKXwmfCN8JClgKSxcbiAgICByZXN1bHRzID0gcmVnZXguZXhlYyh1cmwpO1xuICBpZiAoIXJlc3VsdHMpXG4gICAgcmV0dXJuIG51bGw7XG4gIGlmICghcmVzdWx0c1syXSlcbiAgICByZXR1cm4gJyc7XG4gIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQocmVzdWx0c1syXS5yZXBsYWNlKC9cXCsvZywgJyAnKSk7XG59XG5cbi8qKlxuICogRXhwYW5kIGFkZCByZXZpZXcgIFxuICovXG5jb25zdCBhZGRSZXZpZXdCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWRkLXJldmlldycpO1xuYWRkUmV2aWV3QnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZSA9PiB7XG4gIGUucHJldmVudERlZmF1bHQoKTtcbiAgY29uc3QgZm9ybSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdWJtaXQtcmV2aWV3Jyk7XG4gIGZvcm0uc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XG4gIGFkZFJldmlld0J1dHRvbi5zZXRBdHRyaWJ1dGUoJ2FyaWEtZXhwYW5kZWQnLCB0cnVlKTtcbn0pO1xuXG4vKipcbiAqIFBvc3QgcmV2aWV3XG4gKi9cbmNvbnN0IHBvc3RSZXZpZXdCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncG9zdC1yZXZpZXcnKTtcbnBvc3RSZXZpZXdCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHtcbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICBcbiAgY29uc3QgbmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduYW1lJyk7XG4gIGNvbnN0IGNvbW1lbnRzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbW1lbnRzJyk7XG4gIGNvbnN0IHJhdGluZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyYXRpbmcnKTtcblxuICAvLyBWYWxpZGF0ZSByZXZpZXcgZmllbGRzXG4gIGlmIChuYW1lLnZhbHVlID09PSAnJyB8fCBjb21tZW50cy52YWx1ZSA9PT0gJycgfHwgcmF0aW5nLnZhbHVlID09PSAnJykgcmV0dXJuO1xuXG4gIGNvbnN0IHJldmlldyA9IHt9XG4gIHJldmlldy5uYW1lID0gbmFtZS52YWx1ZTtcbiAgcmV2aWV3LnJhdGluZyA9IHJhdGluZy52YWx1ZTtcbiAgcmV2aWV3LmNvbW1lbnRzID0gY29tbWVudHMudmFsdWU7XG4gIHJldmlldy5kYXRlID0gbW9tZW50KCkuZm9ybWF0KCdNTU1NIEQsIFlZWVknKTtcbiAgcmV2aWV3LnN5bmNlZCA9IGZhbHNlO1xuXG4gIC8vIFJlc2V0IHZhbHVlc1xuICBuYW1lLnZhbHVlID0gJyc7XG4gIGNvbW1lbnRzLnZhbHVlID0gJyc7XG4gIHJhdGluZy52YWx1ZSA9IC0xO1xuXG4gIC8vIEZldGNoIHJlc3RhdXJhbnQgZnJvbSBEQlxuICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRCeUlkKHNlbGYucmVzdGF1cmFudC5pZCwgKGVycm9yLCByZXN0YXVyYW50KSA9PiB7XG4gICAgaWYgKHJlc3RhdXJhbnQpIHtcbiAgICAgIHNlbGYucmVzdGF1cmFudCA9IHJlc3RhdXJhbnQ7XG5cbiAgICAgIGlmIChBcnJheS5pc0FycmF5KHNlbGYucmVzdGF1cmFudC5yZXZpZXdzKSkge1xuICAgICAgICBzZWxmLnJlc3RhdXJhbnQucmV2aWV3cy5wdXNoKHJldmlldyk7XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgc2VsZi5yZXN0YXVyYW50LnJldmlld3MgPSBbXTtcbiAgICAgICAgc2VsZi5yZXN0YXVyYW50LnJldmlld3MucHVzaChyZXZpZXcpO1xuICAgICAgfVxuXG4gICAgICBEQkhlbHBlci51cGRhdGVSZXN0YXVyYW50UmV2aWV3cyhzZWxmLnJlc3RhdXJhbnQpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgIGNvbnN0IGZvcm0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3VibWl0LXJldmlldycpO1xuICAgICAgICAgIGZvcm0uc3R5bGUuZGlzcGxheSA9ICdub25lJztcblxuICAgICAgICAgIGFkZFJldmlld0J1dHRvbi5zZXRBdHRyaWJ1dGUoJ2FyaWEtZXhwYW5kZWQnLCBmYWxzZSk7XG5cbiAgICAgICAgICBjb25zdCB0b2FzdCA9IFRvYXN0LmNyZWF0ZSh7XG4gICAgICAgICAgICB0ZXh0OiBcIlJldmlldyBzdWJtaXR0ZWQuXCJcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBUb2FzdC5zZXRUaW1lb3V0KHRvYXN0LmlkLCAyMDAwKTtcblxuICAgICAgICAgIGZpbGxSZXZpZXdzSFRNTCgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xufSk7XG5cbi8qKlxuICogT2ZmbGluZSBldmVudCBoYW5kbGVyXG4gKi9cbndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdvZmZsaW5lJywgKCkgPT4ge1xuICBjb25zdCB0b2FzdCA9IFRvYXN0LmNyZWF0ZSh7XG4gICAgdGV4dDogXCJVbmFibGUgdG8gY29ubmVjdC4gUmV0cnlpbmcuLi5cIlxuICB9KTtcblxuICBUb2FzdC5zZXRUaW1lb3V0KHRvYXN0LmlkLCA1MDAwKTtcbn0pO1xuXG4vKipcbiAqIE9ubGluZSBldmVudCBoYW5kbGVyXG4gKi9cbndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdvbmxpbmUnLCAoKSA9PiB7XG4gIHdvcmtlci5wb3N0TWVzc2FnZSh7XG4gICAgY21kOiAnc3luY19yZXZpZXdzJ1xuICB9KTtcbn0pIl0sImZpbGUiOiJyZXN0YXVyYW50X2luZm8uanMifQ==
